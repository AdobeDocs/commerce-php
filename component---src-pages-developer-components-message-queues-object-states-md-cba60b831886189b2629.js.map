{"version":3,"file":"component---src-pages-developer-components-message-queues-object-states-md-cba60b831886189b2629.js","mappings":"8QAQaA,EAAe,GACtBC,EAAc,CAClBD,aAAAA,GAEIE,EAAYC,EAAAA,EACH,SAASC,EAAT,GAGZ,IAFDC,EAEC,EAFDA,WACGC,GACF,YACD,OAAO,SAACJ,GAAD,UAAeD,EAAiBK,EAAhC,CAAuCD,WAAYA,EAAYE,QAAQ,eAG5E,eACE,GAAM,6CADR,8CAGA,wWACA,+FAAgF,uBAAYC,WAAW,KAAvB,cAAhF,mFAC0B,uBAAYA,WAAW,KAAvB,cAD1B,iBAEA,oBACE,eAAIA,WAAW,OAAK,uBAAYA,WAAW,MAAvB,wEAApB,kCAAuK,uBAAYA,WAAW,MAAvB,OAAvK,oGACA,eAAIA,WAAW,OAAK,uBAAYA,WAAW,MAAvB,yEAApB,kCAAwK,uBAAYA,WAAW,MAAvB,oBAAxK,qGACA,eAAIA,WAAW,OAAK,uBAAYA,WAAW,MAAvB,4EAApB,kCAA2K,uBAAYA,WAAW,MAAvB,mBAA3K,0GAEF,6DAA8C,uBAAYA,WAAW,KAAvB,8BAA9C,sLAA0S,uBAAYA,WAAW,KAAvB,YAA1S,mBACA,0HAA2G,uBAAYA,WAAW,KAAvB,cAA3G,gBACA,yBAAU,uBAAYA,WAAW,KAAvB,cAAV,kGAAkK,uBAAYA,WAAW,KAAvB,oBAAlK,gNAA8a,uBAAYA,WAAW,KAAvB,cAA9a,MACA,eACE,GAAM,oCADR,eAEkB,uBAAYA,WAAW,MAAvB,cAFlB,gBAGA,iCAAkB,uBAAYA,WAAW,KAAvB,OAAlB,QAAyE,uBAAYA,WAAW,KAAvB,0BAAzE,kBAA6J,uBAAYA,WAAW,KAAvB,oCAC7J,qBAAK,iBAAMA,WAAW,MAClB,UAAa,gBADZ,wNAcL,iCAAkB,uBAAYA,WAAW,KAAvB,oBAAlB,QAAsF,uBAAYA,WAAW,KAAvB,2BAAtF,kBAA2K,uBAAYA,WAAW,KAAvB,qDAA3K,MACA,qBAAK,iBAAMA,WAAW,MAClB,UAAa,gBADZ,qVAeL,iCAAkB,uBAAYA,WAAW,KAAvB,mBAAlB,QAAqF,uBAAYA,WAAW,KAAvB,8BAArF,kBAA6K,uBAAYA,WAAW,KAAvB,qDAA7K,MACA,qBAAK,iBAAMA,WAAW,MAClB,UAAa,gBADZ,q2BA+BTJ,EAAWK,gBAAiB","sources":["webpack://commerce-php/./src/pages/developer/components/message-queues/object-states.md"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/runner/work/commerce-php/commerce-php/node_modules/@adobe/gatsby-theme-aio/src/components/MDXFilter/index.js\";\nexport const _frontmatter = {};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"handling-outdated-in-memory-object-states\"\n    }}>{`Handling outdated in-memory object states`}</h1>\n    <p>{`When Adobe Commerce or Magento Open Source is launched, the store's configuration is loaded into memory. The application uses the in-memory configuration for queue message transactions. When the store's configuration is updated in Admin, the copy in memory does not refresh automatically, resulting in an outdated in-memory object state.`}</p>\n    <p>{`To ensure the copy in memory is re-instantiated after an update, use the `}<inlineCode parentName=\"p\">{`PoisonPill`}</inlineCode>{` interfaces available in the MessageQueue module.\nThere are three type of the `}<inlineCode parentName=\"p\">{`PoisonPill`}</inlineCode>{` interfaces:`}</p>\n    <ul>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`Magento\\\\Framework\\\\MessageQueue\\\\PoisonPill\\\\PoisonPillPutInterface`}</inlineCode>{` - the interface contains the `}<inlineCode parentName=\"li\">{`put`}</inlineCode>{` method. An implementation of the method puts a new version of poison pill inside the database.`}</li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`Magento\\\\Framework\\\\MessageQueue\\\\PoisonPill\\\\PoisonPillReadInterface`}</inlineCode>{` - the interface contains the `}<inlineCode parentName=\"li\">{`getLatestVersion`}</inlineCode>{` method. An implementation of the method gets and returns get latest version of the poison pill.`}</li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`Magento\\\\Framework\\\\MessageQueue\\\\PoisonPill\\\\PoisonPillCompareInterface`}</inlineCode>{` - the interface contains the `}<inlineCode parentName=\"li\">{`isLatestVersion`}</inlineCode>{` method. An implementation of the method checks if the version of current poison pill is the latest.`}</li>\n    </ul>\n    <p>{`Before a new message is processed, the `}<inlineCode parentName=\"p\">{`PoisonPillCompareInterface`}</inlineCode>{` compares the version of the in-memory copy to the latest in the database. If the versions are different, the in-memory copy is destroyed and a new copy is created when the next `}<inlineCode parentName=\"p\">{`cron:run`}</inlineCode>{` job executes.`}</p>\n    <p>{`In addition to changes in the configuration, a new store view or a new website can also trigger the `}<inlineCode parentName=\"p\">{`PoisonPill`}</inlineCode>{` interface.`}</p>\n    <p>{`If `}<inlineCode parentName=\"p\">{`PoisonPill`}</inlineCode>{` determines the copy of the in-memory state needs to be re-instantiated and you have set up a `}<inlineCode parentName=\"p\">{`consumers_runner`}</inlineCode>{` cron job, the application will automatically restart all consumers on the next run of the job. If you did not set up the cron job, you will need to manually restart any consumers that were terminated by `}<inlineCode parentName=\"p\">{`PoisonPill`}</inlineCode>{`.`}</p>\n    <h2 {...{\n      \"id\": \"how-to-use-poisonpill-interfaces\"\n    }}>{`How to use `}<inlineCode parentName=\"h2\">{`PoisonPill`}</inlineCode>{` interfaces`}</h2>\n    <p>{`The method `}<inlineCode parentName=\"p\">{`put`}</inlineCode>{` of `}<inlineCode parentName=\"p\">{`PoisonPillPutInterface`}</inlineCode>{` using in the `}<inlineCode parentName=\"p\">{`Magento\\\\Store\\\\Model\\\\Website`}</inlineCode></p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{` /**\n  * Clear configuration cache after creation website\n  * @return $this\n  * @since 100.2.0\n  */\n public function afterSave()\n {\n   ...\n   $this->pillPut->put();\n   return parent::afterSave();\n }\n`}</code></pre>\n    <p>{`The method `}<inlineCode parentName=\"p\">{`getLatestVersion`}</inlineCode>{` of `}<inlineCode parentName=\"p\">{`PoisonPillReadInterface`}</inlineCode>{` using in the `}<inlineCode parentName=\"p\">{`Magento\\\\Framework\\\\MessageQueue\\\\CallbackInvoker`}</inlineCode>{`:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{` /**\n  * Run short running process\n  * @param QueueInterface $queue\n  * @param int $maxNumberOfMessages\n  * @param \\\\Closure $callback\n  * @return void\n  */\n public function invoke(QueueInterface $queue, $maxNumberOfMessages, $callback)\n {\n   $this->poisonPillVersion = $this->poisonPillRead->getLatestVersion();\n   ...\n }\n`}</code></pre>\n    <p>{`The method `}<inlineCode parentName=\"p\">{`isLatestVersion`}</inlineCode>{` of `}<inlineCode parentName=\"p\">{`PoisonPillCompareInterface`}</inlineCode>{` using in the `}<inlineCode parentName=\"p\">{`Magento\\\\Framework\\\\MessageQueue\\\\CallbackInvoker`}</inlineCode>{`:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{` /**\n  * Run short running process\n  *\n  * @param QueueInterface $queue\n  * @param int $maxNumberOfMessages\n  * @param \\\\Closure $callback\n  * @return void\n  */\n public function invoke(QueueInterface $queue, $maxNumberOfMessages, $callback)\n {\n     $this->poisonPillVersion = $this->poisonPillRead->getLatestVersion();\n     for ($i = $maxNumberOfMessages; $i > 0; $i--) {\n         do {\n             $message = $queue->dequeue();\n             // phpcs:ignore Magento2.Functions.DiscouragedFunction\n            } while ($message === null && (sleep(1) === 0));\n         if (false === $this->poisonPillCompare->isLatestVersion($this->poisonPillVersion)) {\n             $queue->reject($message);\n             // phpcs:ignore Magento2.Security.LanguageConstruct.ExitUsage\n             exit(0);\n         }\n         $callback($message);\n     }\n }\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"sourceRoot":""}