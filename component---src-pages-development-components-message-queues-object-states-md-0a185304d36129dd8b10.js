"use strict";(self.webpackChunkcommerce_php=self.webpackChunkcommerce_php||[]).push([[29583],{79937:function(e,n,t){t.r(n),t.d(n,{_frontmatter:function(){return l},default:function(){return p}});var a=t(58168),o=t(80045),i=(t(88763),t(15680)),r=t(83407);const s=["components"],l={},m={_frontmatter:l},u=r.A;function p(e){let{components:n}=e,t=(0,o.A)(e,s);return(0,i.mdx)(u,(0,a.A)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,i.mdx)("h1",{id:"handling-outdated-in-memory-object-states"},"Handling outdated in-memory object states"),(0,i.mdx)("p",null,"When Adobe Commerce or Magento Open Source is launched, the store's configuration is loaded into memory. The application uses the in-memory configuration for queue message transactions. When the store's configuration is updated in Admin, the copy in memory does not refresh automatically, resulting in an outdated in-memory object state."),(0,i.mdx)("p",null,"To ensure the copy in memory is re-instantiated after an update, use the ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPill")," interfaces available in the MessageQueue module.\nThere are three type of the ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPill")," interfaces:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"Magento\\Framework\\MessageQueue\\PoisonPill\\PoisonPillPutInterface")," - the interface contains the ",(0,i.mdx)("inlineCode",{parentName:"li"},"put")," method. An implementation of the method puts a new version of poison pill inside the database."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"Magento\\Framework\\MessageQueue\\PoisonPill\\PoisonPillReadInterface")," - the interface contains the ",(0,i.mdx)("inlineCode",{parentName:"li"},"getLatestVersion")," method. An implementation of the method gets and returns get latest version of the poison pill."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"Magento\\Framework\\MessageQueue\\PoisonPill\\PoisonPillCompareInterface")," - the interface contains the ",(0,i.mdx)("inlineCode",{parentName:"li"},"isLatestVersion")," method. An implementation of the method checks if the version of current poison pill is the latest.")),(0,i.mdx)("p",null,"Before a new message is processed, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPillCompareInterface")," compares the version of the in-memory copy to the latest in the database. If the versions are different, the in-memory copy is destroyed and a new copy is created when the next ",(0,i.mdx)("inlineCode",{parentName:"p"},"cron:run")," job executes."),(0,i.mdx)("p",null,"In addition to changes in the configuration, a new store view or a new website can also trigger the ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPill")," interface."),(0,i.mdx)("p",null,"If ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPill")," determines the copy of the in-memory state needs to be re-instantiated and you have set up a ",(0,i.mdx)("inlineCode",{parentName:"p"},"consumers_runner")," cron job, the application will automatically restart all consumers on the next run of the job. If you did not set up the cron job, you will need to manually restart any consumers that were terminated by ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPill"),"."),(0,i.mdx)("h2",{id:"how-to-use-poisonpill-interfaces"},"How to use ",(0,i.mdx)("inlineCode",{parentName:"h2"},"PoisonPill")," interfaces"),(0,i.mdx)("p",null,"The method ",(0,i.mdx)("inlineCode",{parentName:"p"},"put")," of ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPillPutInterface")," using in the ",(0,i.mdx)("inlineCode",{parentName:"p"},"Magento\\Store\\Model\\Website")),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-php"}," /**\n  * Clear configuration cache after creation website\n  * @return $this\n  * @since 100.2.0\n  */\n public function afterSave()\n {\n   ...\n   $this->pillPut->put();\n   return parent::afterSave();\n }\n")),(0,i.mdx)("p",null,"The method ",(0,i.mdx)("inlineCode",{parentName:"p"},"getLatestVersion")," of ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPillReadInterface")," using in the ",(0,i.mdx)("inlineCode",{parentName:"p"},"Magento\\Framework\\MessageQueue\\CallbackInvoker"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-php"}," /**\n  * Run short running process\n  * @param QueueInterface $queue\n  * @param int $maxNumberOfMessages\n  * @param \\Closure $callback\n  * @return void\n  */\n public function invoke(QueueInterface $queue, $maxNumberOfMessages, $callback)\n {\n   $this->poisonPillVersion = $this->poisonPillRead->getLatestVersion();\n   ...\n }\n")),(0,i.mdx)("p",null,"The method ",(0,i.mdx)("inlineCode",{parentName:"p"},"isLatestVersion")," of ",(0,i.mdx)("inlineCode",{parentName:"p"},"PoisonPillCompareInterface")," using in the ",(0,i.mdx)("inlineCode",{parentName:"p"},"Magento\\Framework\\MessageQueue\\CallbackInvoker"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-php"}," /**\n  * Run short running process\n  *\n  * @param QueueInterface $queue\n  * @param int $maxNumberOfMessages\n  * @param \\Closure $callback\n  * @return void\n  */\n public function invoke(QueueInterface $queue, $maxNumberOfMessages, $callback)\n {\n     $this->poisonPillVersion = $this->poisonPillRead->getLatestVersion();\n     for ($i = $maxNumberOfMessages; $i > 0; $i--) {\n         do {\n             $message = $queue->dequeue();\n             // phpcs:ignore Magento2.Functions.DiscouragedFunction\n            } while ($message === null && (sleep(1) === 0));\n         if (false === $this->poisonPillCompare->isLatestVersion($this->poisonPillVersion)) {\n             $queue->reject($message);\n             // phpcs:ignore Magento2.Security.LanguageConstruct.ExitUsage\n             exit(0);\n         }\n         $callback($message);\n     }\n }\n")))}p.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-development-components-message-queues-object-states-md-0a185304d36129dd8b10.js.map