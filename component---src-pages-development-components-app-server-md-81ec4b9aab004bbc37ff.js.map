{"version":3,"file":"component---src-pages-development-components-app-server-md-81ec4b9aab004bbc37ff.js","mappings":"qRAQaA,EAAe,CAAC,EAOvBC,GALgBC,EAKY,cALJ,SAA6BC,GAEzD,OADAC,QAAQC,KAAK,aAAeH,EAAO,4EAC5B,eAASC,EACjB,GAHqBD,MAMtB,MAAMI,EAAc,CAClBN,gBAEIO,EAAYC,EAAAA,EACH,SAASC,EAAT,GAGZ,IAHgC,WACjCC,GAEC,EADEP,GACF,YACD,OAAO,SAACI,GAAD,UAAeD,EAAiBH,EAAhC,CAAuCO,WAAYA,EAAYC,QAAQ,eAG5E,SAACV,EAAD,CAAaW,QAAQ,OAAOC,MAAM,OAAOF,QAAQ,iBACjD,kBAAK,iBAAe,cAAGG,WAAW,IAC9B,KAAQ,qGACL,SAAa,WACpB,eACE,GAAM,8BACH,+BACL,kBAAK,QAAM,cAAGA,WAAW,IACrB,KAAQ,yHACL,8BAAkC,scACzC,kBAAK,2HAAyH,cAAGA,WAAW,IACxI,KAAQ,0HACL,2CAA+C,2DACtD,eACE,GAAM,0BACH,2BACL,kBAAK,mIACL,kBAAK,0MACL,oBACE,eAAIA,WAAW,MAAO,wBACtB,eAAIA,WAAW,MAAO,8BACtB,eAAIA,WAAW,MAAO,wCACtB,eAAIA,WAAW,MAAO,2BAExB,eACE,GAAM,wBACH,yBACL,kBAAK,0BAAwB,uBAAYA,WAAW,KAAM,WAAwB,yjBAClF,eACE,GAAM,6BACH,8BACL,kBAAK,yjBACL,eACE,GAAM,qCACH,wCACL,kBAAK,+SAA6S,uBAAYA,WAAW,KAAM,SAAsB,MAAI,uBAAYA,WAAW,KAAM,UAAuB,UAAQ,uBAAYA,WAAW,KAAM,aAA0B,+HAC5d,kBAAK,wQACL,eACE,GAAM,yBACH,0BACL,kBAAK,grBACL,eACE,GAAM,sCACH,uCACL,oBACE,eAAIA,WAAW,OAAK,cAAGA,WAAW,KAC9B,KAAQ,kDACL,yCAET,oBACE,eAAIA,WAAW,OACb,cAAGA,WAAW,MAAO,yoBAEvB,eAAIA,WAAW,OACb,cAAGA,WAAW,MAAO,8ZAGzB,oBACE,eAAIA,WAAW,MAAO,gCAA8B,uBAAYA,WAAW,MAAO,SAAsB,MAAI,uBAAYA,WAAW,MAAO,UAAuB,UAAQ,uBAAYA,WAAW,MAAO,aAA0B,+HAEnO,eACE,GAAM,uBACH,wBACL,kBAAK,sJACL,eACE,GAAM,qBACH,sBACL,kBAAK,mLACL,kBAAK,0OACL,kBAAK,8GACL,oBACE,eAAIA,WAAW,OAAK,uBAAYA,WAAW,MAAO,8EAA2F,4FAA0F,uBAAYA,WAAW,MAAO,UAAuB,YAC5R,eAAIA,WAAW,OAAK,uBAAYA,WAAW,MAAO,gFAA6F,0DAEjJ,SAACb,EAAD,CAAaW,QAAQ,OAAOC,MAAM,OAAOF,QAAQ,iBACjD,kBAAK,mCAAiC,uBAAYG,WAAW,KAAM,sBAAmC,wDAAsD,uBAAYA,WAAW,KAAM,cAA2B,6DACpN,kBAAK,WAAS,uBAAYA,WAAW,KAAM,yBAAsC,yDACjF,oBACE,eAAIA,WAAW,MAAO,QAAM,uBAAYA,WAAW,MAAO,OAAoB,2EAC9E,eAAIA,WAAW,MAAO,QAAM,uBAAYA,WAAW,MAAO,WAAwB,6FAA2F,uBAAYA,WAAW,MAAO,cAA2B,mEACtO,eAAIA,WAAW,MAAO,QAAM,uBAAYA,WAAW,MAAO,YAAyB,8CAA4C,uBAAYA,WAAW,MAAO,eAA4B,UAAQ,uBAAYA,WAAW,MAAO,eAA4B,iFAA+E,uBAAYA,WAAW,MAAO,UAAuB,oDAEjY,kBAAK,6JAA2J,cAAGA,WAAW,IAC1K,KAAQ,6GACL,wBAA4B,6PAA2P,uBAAYA,WAAW,KAAM,8BAA2C,aAAW,uBAAYA,WAAW,KAAM,iBAA8B,gEAC5a,kBAAK,yCAAuC,uBAAYA,WAAW,KAAM,gEAA6E,mlBACtJ,kBAAK,yBACL,qBAAK,iBAAMA,WAAW,MAClB,UAAa,iBACV,+IAEP,eACE,GAAM,yBACH,0BACL,mBAAG,uBAAYA,WAAW,KAAM,yBAAsC,sCAAoC,uBAAYA,WAAW,KAAM,8BAA2C,2BAAyB,uBAAYA,WAAW,KAAM,iBAA8B,kNAAgN,uBAAYA,WAAW,KAAM,iBAA8B,wFAAsF,uBAAYA,WAAW,KAAM,iBAA8B,uFAAqF,uBAAYA,WAAW,KAAM,iBAA8B,2EAClzB,kBAAK,wLAAsL,uBAAYA,WAAW,KAAM,iBAA8B,8EAA4E,uBAAYA,WAAW,KAAM,iBAA8B,6FAC7X,kBAAK,yCAAuC,uBAAYA,WAAW,KAAM,gEAA6E,yDAAuD,cAAGA,WAAW,IACvN,KAAQ,sBACL,oBAAwB,cAC/B,kBAAK,yBACL,qBAAK,iBAAMA,WAAW,MAClB,UAAa,iBACV,gKAEP,eACE,GAAM,4BACH,6BACL,kBAAK,2CACL,oBACE,eAAIA,WAAW,OACb,cAAGA,WAAW,MAAO,kCACrB,gBAAKA,WAAW,OAAK,iBAAMA,WAAW,MAClC,UAAa,iBACV,4BAGT,eAAIA,WAAW,OACb,cAAGA,WAAW,MAAO,8EACrB,gBAAKA,WAAW,OAAK,iBAAMA,WAAW,MAClC,UAAa,gBACV,yLAQT,eAAIA,WAAW,OACb,cAAGA,WAAW,MAAO,6DACrB,gBAAKA,WAAW,OAAK,iBAAMA,WAAW,MAClC,UAAa,iBACV,+BAGT,eAAIA,WAAW,OACb,cAAGA,WAAW,MAAO,oGAGzB,eACE,GAAM,oCACH,qCACL,kBAAK,qBAAmB,uBAAYA,WAAW,KAAM,kDAA+D,YACpH,qBAAK,iBAAMA,WAAW,MAClB,UAAa,gBACV,yDAKP,kBAAK,gDAA8C,uBAAYA,WAAW,KAAM,SAAsB,uBACtG,qBAAK,iBAAMA,WAAW,MAClB,UAAa,gBACV,8qBAiBP,eACE,GAAM,4BACH,6BACL,kBAAK,0HACL,oBACE,eAAIA,WAAW,MAAO,4BACtB,eAAIA,WAAW,MAAO,2BACtB,eAAIA,WAAW,MAAO,kBAExB,kBAAK,4BAA0B,cAAGA,WAAW,IACzC,KAAQ,sCACP,uBAAYA,WAAW,KAAM,mDAAmE,2DAAyD,uBAAYA,WAAW,KAAM,SAAsB,mGACjN,kBAAK,yDACL,qBAAK,iBAAMA,WAAW,MAClB,UAAa,gBACV,yDAEP,kBAAK,kCAAgC,uBAAYA,WAAW,KAAM,iBAA8B,4BAA0B,uBAAYA,WAAW,KAAM,SAAsB,kDAC7K,qBAAK,iBAAMA,WAAW,MAClB,UAAa,gBACV,iGAUV,CAEDL,EAAWM,gBAAiB,C","sources":["webpack://commerce-php/./src/pages/development/components/app-server.md"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/runner/work/commerce-php/commerce-php/node_modules/@adobe/gatsby-theme-aio/src/components/MDXFilter/index.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst InlineAlert = makeShortcode(\"InlineAlert\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <InlineAlert variant=\"info\" slots=\"text\" mdxType=\"InlineAlert\" />\n    <p>{`Available in `}<a parentName=\"p\" {...{\n        \"href\": \"https://experienceleague.adobe.com/en/docs/commerce-operations/release/notes/adobe-commerce/2-4-7\"\n      }}>{`2.4.7`}</a>{` only.`}</p>\n    <h1 {...{\n      \"id\": \"graphql-application-server\"\n    }}>{`GraphQL Application Server`}</h1>\n    <p>{`The `}<a parentName=\"p\" {...{\n        \"href\": \"https://experienceleague.adobe.com/en/docs/commerce-operations/performance-best-practices/concepts/application-server\"\n      }}>{`GraphQL Application Server`}</a>{` enables Adobe Commerce to maintain state among GraphQL API requests. GraphQL Application Server, which is built on the Open Swoole extension, operates as a process with worker threads that handle request processing. By preserving a bootstrapped application state among GraphQL API requests, GraphQL Application Server enhances request handling and overall product performance. As a result, GraphQL request response time can be reduced by up to 30%.`}</p>\n    <p>{`GraphQL Application Server is available for Adobe Commerce only. It is not available for Magento Open Source. You must `}<a parentName=\"p\" {...{\n        \"href\": \"https://experienceleague.adobe.com/en/docs/commerce-knowledge-base/kb/help-center-guide/magento-help-center-user-guide\"\n      }}>{`submit an Adobe Commerce Support ticket`}</a>{` to enable GraphQL Application Server on Pro projects.`}</p>\n    <h2 {...{\n      \"id\": \"challenges-to-consider\"\n    }}>{`Challenges to consider`}</h2>\n    <p>{`Ensuring compatibility between your extension and GraphQL Application Server can be challenging without the right information.`}</p>\n    <p>{`This page provides all the details that you need to make sure that your code is compatible with GraphQL Application Server, including recommendations and testing instructions. Key concepts include:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Resource management`}</li>\n      <li parentName=\"ul\">{`Memory and resource leaks`}</li>\n      <li parentName=\"ul\">{`Cookies, sessions, and superglobals`}</li>\n      <li parentName=\"ul\">{`Testing and debugging`}</li>\n    </ul>\n    <h3 {...{\n      \"id\": \"resources-management\"\n    }}>{`Resources Management`}</h3>\n    <p>{`In environments using `}<inlineCode parentName=\"p\">{`php-fpm`}</inlineCode>{`, SQL connections, file handles, and other resources are automatically closed or reset at the conclusion of each HTTP request, ensuring that each new request starts with a clean slate. This mechanism helps prevent memory leaks and resource exhaustion, which can lead to degraded performance or application failure. The Application Server contains a cleanup process. This process is triggered after a response is dispatched, guaranteeing that all resources are properly released or reset, thereby maintaining the application's performance and reliability over time.`}</p>\n    <h3 {...{\n      \"id\": \"memory-and-resource-leaks\"\n    }}>{`Memory and resource leaks`}</h3>\n    <p>{`Memory and resource management in PHP can often be overlooked due to the stateless nature of HTTP request handling, where resources are automatically released at the end of each request. However, in long-running scripts or applications, such as those using Swoole, proper management becomes crucial to prevent leaks and ensure efficient operation. Leaks occur when the application fails to release memory or resources that are no longer needed, leading to increased memory consumption and potential degradation of performance or even application failure over time.`}</p>\n    <h3 {...{\n      \"id\": \"cookies-sessions-and-superglobals\"\n    }}>{`Cookies, sessions, and superglobals`}</h3>\n    <p>{`Using cookies, sessions, and superglobals can be a challenge due to Swoole's asynchronous, long-running server environment, which differs significantly from the traditional, stateless PHP-FPM model. Since Swoole keeps the PHP application in memory across requests, traditional PHP superglobals like `}<inlineCode parentName=\"p\">{`$_GET`}</inlineCode>{`, `}<inlineCode parentName=\"p\">{`$_POST`}</inlineCode>{`, and `}<inlineCode parentName=\"p\">{`$_SESSION`}</inlineCode>{` do not automatically reset between requests, potentially leading to data leakage or incorrect data being served to users.`}</p>\n    <p>{`Additionally, implementing session management and cookie handling requires careful consideration to ensure thread safety and data isolation among concurrent requests, posing a significant challenge in preserving the state and security of a Swoole application.`}</p>\n    <h3 {...{\n      \"id\": \"testing-and-debugging\"\n    }}>{`Testing and debugging`}</h3>\n    <p>{`Traditional debugging tools and techniques designed for synchronous PHP scripts may not work as expected, as they might not properly handle the concurrency and parallel execution of tasks within Swoole. Developers must adopt or develop tools that are capable of understanding and interacting with asynchronous operations, as well as establish testing environments that can simulate the concurrent execution of multiple requests. This requires a shift in approach to both debugging and testing, with an emphasis on asynchronous logic, co-routine lifecycle management, and the potential for shared-state issues, making the process more challenging than in traditional PHP environments.`}</p>\n    <h2 {...{\n      \"id\": \"common-reasons-for-incompatibility\"\n    }}>{`Common reasons for incompatibility`}</h2>\n    <ol>\n      <li parentName=\"ol\"><a parentName=\"li\" {...{\n          \"href\": \"../../coding-standards/technical-guidelines.md\"\n        }}>{`Not following technical guidelines`}</a></li>\n    </ol>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`2.9. Service classes (ones that provide behavior but not data, like EventManager) SHOULD NOT have a mutable state. To make extensions codebase compliant with technical guidelines mutable states should be removed from Service classes. For example, a property cache introduced for better performance when dealing with data-intensive operations, such as database queries, API calls, or complex calculations, that does not need to be executed repeatedly within the same request. However, this can cause issues with GraphQL Application Server, since the property cache would be used in consequent requests and it should be reset after each request.`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`2.14. Temporal coupling MUST be avoided. Changed state at one point in time can inadvertently affect the behavior of subsequent operations, requiring a specific order of execution for the application to function correctly. This coupling makes the code harder to understand and maintain, as the correct operation of the system becomes dependent on the sequence in which state-modifying actions are performed.`}</p>\n      </li>\n    </ul>\n    <ol>\n      <li parentName=\"ol\">{`Usage of superglobals, like `}<inlineCode parentName=\"li\">{`$_GET`}</inlineCode>{`, `}<inlineCode parentName=\"li\">{`$_POST`}</inlineCode>{`, and `}<inlineCode parentName=\"li\">{`$_SESSION`}</inlineCode>{`, and native PHP functions for header, session, and cookie, instead of utilizing interfaces through dependency injection.`}</li>\n    </ol>\n    <h2 {...{\n      \"id\": \"integration-testing\"\n    }}>{`Integration testing`}</h2>\n    <p>{`This section describes integration tests that you can use when developing your extension to ensure compatibility with GraphQL Application Server.`}</p>\n    <h3 {...{\n      \"id\": \"graphqlstatetests\"\n    }}>{`GraphQlStateTests`}</h3>\n    <p>{`This test finds the state in shared objects that should not be reused for multiple requests. It currently runs against 67 different GraphQL requests, which could be extended.`}</p>\n    <p>{`GraphQlStateTest is a test that looks for state changes in service objects created by ObjectManager. It does this by running a GraphQL query twice, and comparing the state of the service objects before and after the second query.`}</p>\n    <p>{`There are two files used to filter and skip classes that are safe to be reused in a stateful application:`}</p>\n    <ul>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`dev/tests/integration/testsuite/Magento/GraphQl/_files/state-skip-list.php`}</inlineCode>{`—Skips the comparison of objects by their class name or virtual name (as defined in the `}<inlineCode parentName=\"li\">{`di.xml`}</inlineCode>{` file).`}</li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`dev/tests/integration/testsuite/Magento/GraphQl/_files/state-filter-list.php`}</inlineCode>{`—Filters out the properties that should be compared.`}</li>\n    </ul>\n    <InlineAlert variant=\"info\" slots=\"text\" mdxType=\"InlineAlert\" />\n    <p>{`There are similar files in the `}<inlineCode parentName=\"p\">{`magento/magento2ee`}</inlineCode>{` GitHub repository for classes that are specific to `}<inlineCode parentName=\"p\">{`magento2ee`}</inlineCode>{`. Similarly, other repositories can use their own files.`}</p>\n    <p>{`In the `}<inlineCode parentName=\"p\">{`state-filter-list.php`}</inlineCode>{` file, there are three different types of filtering:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`The `}<inlineCode parentName=\"li\">{`all`}</inlineCode>{` section filters these property names from all of the service objects.`}</li>\n      <li parentName=\"ul\">{`The `}<inlineCode parentName=\"li\">{`parents`}</inlineCode>{` section first compares the service object to the specified class or interface using the `}<inlineCode parentName=\"li\">{`instanceof`}</inlineCode>{` operator. If it returns true, then those filters are applied.`}</li>\n      <li parentName=\"ul\">{`The `}<inlineCode parentName=\"li\">{`services`}</inlineCode>{` section checks for direct matches of the `}<inlineCode parentName=\"li\">{`serviceName`}</inlineCode>{`. The `}<inlineCode parentName=\"li\">{`serviceName`}</inlineCode>{` can either be the class name, or virtual type of preferences (as defined in `}<inlineCode parentName=\"li\">{`di.xml`}</inlineCode>{` files) before applying the properties filter.`}</li>\n    </ul>\n    <p>{`If you are working on a failure and it does not look like it is safe to add to the skip or filter list, then consider if you can refactor the class in a `}<a parentName=\"p\" {...{\n        \"href\": \"https://developer.adobe.com/commerce/contributor/guides/code-contributions/backward-compatibility-policy/\"\n      }}>{`backwards-compatible`}</a>{` way to use Factories of the service classes that have mutable state. If it is the class itself that has mutable state, then try to rewrite it in a way to avoid mutable state. If the mutable state is required for performance reasons, then implement `}<inlineCode parentName=\"p\">{`ResetAfterRequestInterface`}</inlineCode>{` and use `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{` to reset the object back to its initial constructed state.`}</p>\n    <p>{`If the class is failing because of a `}<inlineCode parentName=\"p\">{`Typed property $x must not be accessed before initialization`}</inlineCode>{` error, then the property is not initialized by the constructor. This is a form of temporal coupling, because the object cannot be used after it is initially constructed. This happens even if the property is private because the Collector gets the data from the properties using PHP's reflection feature. In this case, refactor the class to avoid temporal coupling, and also to avoid mutable state. If that does not work, the property can change its type to a nullable type and be initialized to null. If the property is an array, it may be okay to initialize the property as an empty array.`}</p>\n    <p>{`Command to run test:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`vendor/bin/phpunit -c $(pwd)/dev/tests/integration/phpunit.xml dev/tests/integration/testsuite/Magento/GraphQl/App/GraphQlStateTest.php\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"resetafterrequesttest\"\n    }}>{`ResetAfterRequestTest`}</h3>\n    <p><inlineCode parentName=\"p\">{`ResetAfterRequestTest`}</inlineCode>{` finds all classes that implement `}<inlineCode parentName=\"p\">{`ResetAfterRequestInterface`}</inlineCode>{` and verifies that the `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{` method returns the state of the object to the same state as it was after being constructed by ObjectManager. It does this by creating a service object with ObjectManager, cloning that object, then calling `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{` and comparing it. It does not call any methods in between object instantiation and `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{`, so it does not confirm resetting any mutable state. If it finds bugs or typos in `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{`, it may set the state to something different than the original state.`}</p>\n    <p>{`If this test fails, then you should check to see if you have changed a class in a way where the object has different values in properties after construction comparted to after the `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{` method is called. If the class that you are working on does not have the `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{` method itself, then check the class hierarchy for a superclass that is implementing it.`}</p>\n    <p>{`If the class is failing because of a `}<inlineCode parentName=\"p\">{`Typed property $x must not be accessed before initialization`}</inlineCode>{` error, see the discussion about this problem in the `}<a parentName=\"p\" {...{\n        \"href\": \"#graphqlstatetests\"\n      }}>{`GraphQlStateTest`}</a>{` section.`}</p>\n    <p>{`Command to run test:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`vendor/bin/phpunit -c $(pwd)/dev/tests/integration/phpunit.xml dev/tests/integration/testsuite/Magento/Framework/ObjectManager/ResetAfterRequestTest.php\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"how-to-fix-test-failures\"\n    }}>{`How to fix test failures`}</h2>\n    <p>{`To set up local testing and debugging:`}</p>\n    <ol>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Install the Swoole extension:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-bash\"\n          }}>{`pecl install swoole\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Route all GraphQL requests to GraphQL Application Server (nginx example):`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-php\"\n          }}>{`location /graphql {\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n    proxy_pass http://127.0.0.1:9501/graphql;\n}\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Run the GraphQL Application Server with the CLI command:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-bash\"\n          }}>{`bin/magento server:run\n`}</code></pre>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Execute GraphQL mutations against GraphQL Application Server and debug with xDebug if needed.`}</p>\n      </li>\n    </ol>\n    <h2 {...{\n      \"id\": \"example-of-mutable-state-in-code\"\n    }}>{`Example of mutable state in code`}</h2>\n    <p>{`Example with the `}<inlineCode parentName=\"p\">{`Magento\\\\Catalog\\\\Model\\\\Product\\\\Image\\\\Cache`}</inlineCode>{` class:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`/**\n  * @var array\n  */\n protected $data = [];\n`}</code></pre>\n    <p>{`Review the following example to see how the `}<inlineCode parentName=\"p\">{`$data`}</inlineCode>{` property is used:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`   protected function getData()\n   {\n       if (!$this->data) {\n           foreach ($this->themeCollection->loadRegisteredThemes() as $theme) {\n               $config = $this->viewConfig->getViewConfig([\n                   'area' => Area::AREA_FRONTEND,\n                   'themeModel' => $theme,\n               ]);\n               $images = $config->getMediaEntities('Magento_Catalog', ImageHelper::MEDIA_TYPE_CONFIG_NODE);\n               foreach ($images as $imageId => $imageData) {\n                   $this->data[$theme->getCode() . $imageId] = array_merge(['id' => $imageId], $imageData);\n               }\n           }\n       }\n       return $this->data;\n   }\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"how-to-fix-mutable-state\"\n    }}>{`How to fix mutable state`}</h3>\n    <p>{`There are several challenges you may face for refactoring the code with mutable state, including, but not limited to:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Backwards compatibility`}</li>\n      <li parentName=\"ul\">{`Performance efficiency`}</li>\n      <li parentName=\"ul\">{`Lack of time`}</li>\n    </ul>\n    <p>{`In the example with the `}<a parentName=\"p\" {...{\n        \"href\": \"#example-of-mutable-state-in-code\"\n      }}><inlineCode parentName=\"a\">{`Magento\\\\Catalog\\\\Model\\\\Product\\\\Image\\\\Cache`}</inlineCode></a>{` class, we can see performance benefits of reusing the `}<inlineCode parentName=\"p\">{`$data`}</inlineCode>{` property in the context of a single request, but we should reset the state after the request.`}</p>\n    <p>{`For this purpose, we should implement the following:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`class Cache implements ResetAfterRequestInterface\n`}</code></pre>\n    <p>{`Add the implementation of the `}<inlineCode parentName=\"p\">{`_resetState()`}</inlineCode>{` method with overriding `}<inlineCode parentName=\"p\">{`$data`}</inlineCode>{` property to its initial state - empty array:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`/**\n * @inheritDoc\n */\npublic function _resetState(): void\n{\n    $this->data = [];\n}\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["_frontmatter","InlineAlert","name","props","console","warn","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","variant","slots","parentName","isMDXComponent"],"sourceRoot":""}