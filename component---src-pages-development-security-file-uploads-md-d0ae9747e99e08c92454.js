"use strict";(self.webpackChunkcommerce_php=self.webpackChunkcommerce_php||[]).push([[94999],{95891:function(e,t,i){i.r(t),i.d(t,{_frontmatter:function(){return s},default:function(){return c}});var a=i(58168),n=i(80045),r=(i(88763),i(15680)),o=i(83407);const l=["components"],s={},d=(m="InlineAlert",function(e){return console.warn("Component "+m+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.mdx)("div",e)});var m;const p={_frontmatter:s},u=o.A;function c(e){let{components:t}=e,i=(0,n.A)(e,l);return(0,r.mdx)(u,(0,a.A)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.mdx)("h1",{id:"file-uploads"},"File uploads"),(0,r.mdx)("p",null,"When working with files, especially user-uploaded files, it is easy to make a mistake and open your store to dangerous attacks like path traversal and remote code execution (RCE). The Adobe Commerce and Magento Open Source framework provides abstraction to help you safely work with user files, but it's your responsibility to use it the right way."),(0,r.mdx)("h2",{id:"when-you-dont-need-a-file"},"When you don't need a file"),(0,r.mdx)("p",null,"There are cases when users can upload files for their own convenience. For example, consider functionality that allows\na customer to upload a ",(0,r.mdx)("inlineCode",{parentName:"p"},".csv")," file with a list of SKUs and quantities to add products to their cart. You don't need to\nstore the file, you only need the contents of the file to add those SKUs to a cart. One option is to read the uploaded file, add\nSKUs, and delete it without ever moving it from the  temporary folder on the file system. Another, even better option for security and\nperformance, is to never upload the file in the first place. The file can be handled on the frontend side using JavaScript\nto extract SKUs and quantities and send those to a web API endpoint on the server."),(0,r.mdx)(d,{variant:"success",slots:"text",mdxType:"InlineAlert"}),(0,r.mdx)("p",null,"The best way to avoid security issues with files is to not upload or store them in the first place\nif you don't have to."),(0,r.mdx)("h2",{id:"files-inaccessible-by-users"},"Files inaccessible by users"),(0,r.mdx)("p",null,"Some files, generated or uploaded, need to be stored on the server for further processing or querying, but should not be directly\naccessible through a URL. Below are measures to avoid potential unauthorized access, path traversal, or RCE problems\nfrom such files:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"Use random file names and extensions (it's better to use no file extensions); do not trust file names provided by users"),(0,r.mdx)("li",{parentName:"ul"},"Store files in a directory specifically for generated/uploaded files"),(0,r.mdx)("li",{parentName:"ul"},"Do not store these files in an HTTP accessible folder (like ",(0,r.mdx)("inlineCode",{parentName:"li"},"/pub"),")"),(0,r.mdx)("li",{parentName:"ul"},"Store file records in a database if the files need to be assigned to an entity"),(0,r.mdx)("li",{parentName:"ul"},"Do not trust user provided file names/IDs when deleting files; validate file ownership through the database")),(0,r.mdx)("p",null,"The ",(0,r.mdx)("inlineCode",{parentName:"p"},"Magento\\Framework\\Filesystem")," class can help you find the right folder to store the files. Usually,\ngenerated or inaccessible files are stored in the ",(0,r.mdx)("inlineCode",{parentName:"p"},"/var")," directory. See the following examples:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-php"},"class MyClass {\n    private \\Magento\\Framework\\Filesystem $filesystem;\n\n    private \\Magento\\Framework\\Filesystem\\Directory\\WriteFactory $writeFactory;\n\n    private \\Magento\\Framework\\Math\\Random $rand;\n\n    public function __construct(\n        \\Magento\\Framework\\Filesystem $filesystem,\n        \\Magento\\Framework\\Filesystem\\Directory\\WriteFactory $writeFactory,\n        \\Magento\\Framework\\Math\\Random $rand\n    ) {\n        $this->filesystem = $filesystem;\n        $this->writeFactory = $writeFactory;\n        $this->rand = $rand;\n    }\n\n    ...\n\n    public function workWithFiles(): void {\n        ...\n\n        //To read \"MAGENTO_ROOT/var\" sub-directories or files.\n        $varDir = $this->filesystem->getDirectoryRead(\\Magento\\Framework\\App\\Filesystem\\DirectoryList::VAR_DIR);\n        //Going to write files into a designated folder specific to these type of files and functionality\n        //Getting WriteInterface instance of `MAGENTO_ROOT/var/my-modules-dir`\n        $thisModulesFilesDir = $this->writeFactory->create($varDir->getAbsolutePath('my-modules-dir'));\n\n        //Random file name\n        $randomFileName = $this->rand->getRandomString(32);\n        //Copying a file from the system temporary directory into it's new path\n        $thisModulesFilesDir->getDriver()\n            ->copy($tmpUploadedOrGeneratedFilePath, $thisModulesFilesDir->getAbsolutePath($randomFileName));\n    }\n}\n")),(0,r.mdx)("h2",{id:"files-that-require-authorization"},"Files that require authorization"),(0,r.mdx)("p",null,"You should treat files that require authorization to download the same way as inaccessible files;\nwith a controller that performs authorization and then serves the file by outputting its content in response body."),(0,r.mdx)("h2",{id:"publicly-accessible-media-files"},"Publicly accessible media files"),(0,r.mdx)("p",null,"Publicly accessible media files present higher risk and require special care because you must keep the user-provided path\nand file extension. You should verify the following:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"Media files can only be placed in a publicly accessible path"),(0,r.mdx)("li",{parentName:"ul"},"Uploaded file path is inside the designated folder or its subdirectories"),(0,r.mdx)("li",{parentName:"ul"},"Extension is safe (use an allow-list)"),(0,r.mdx)("li",{parentName:"ul"},"File path is out of system folders that contain other application files"),(0,r.mdx)("li",{parentName:"ul"},"Prevent deleting system files in public folders"),(0,r.mdx)("li",{parentName:"ul"},"Ideally, verify user's relation to file (ownership), or containing directory before updating or deleting files")),(0,r.mdx)("p",null,"Notes:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"The application uses the ",(0,r.mdx)("inlineCode",{parentName:"li"},"\\Magento\\Framework\\App\\Filesystem\\DirectoryList::PUB")," directory for public files."),(0,r.mdx)("li",{parentName:"ul"},"Uploaded file paths must be validated using the ",(0,r.mdx)("inlineCode",{parentName:"li"},"ReadInterface")," and ",(0,r.mdx)("inlineCode",{parentName:"li"},"WriteInterface")," instances, similar to the preceding example."),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"\\Magento\\Framework\\Filesystem\\Io\\File")," can help extract file extensions from filenames.")),(0,r.mdx)("p",null,"Example of an imaginary class dealing with media files:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-php"},"class MyFileUploader {\n    private const UPLOAD_DIR = 'my-module/customer-jpegs';\n\n    private \\Magento\\Framework\\Filesystem\\Io\\File $fileUtil;\n\n    private array $allowedExt = ['jpg', 'jpeg'];\n\n    private \\Magento\\Framework\\Filesystem\\Directory\\WriteFactory $writeFactory;\n\n    private \\Magento\\Framework\\Filesystem $filesystem;\n\n    /**\n      * @param string $customerId UserContextInterface::getUserId() - current customer\n      * @param array $uploadedFileData uploaded file data from $_FILES\n      * @return MediaFile\n      * @throws \\Magento\\Framework\\Exception\\ValidatorException\n      */\n    public function upload(string $customerId, array $uploadedFileData): MediaFile\n    {\n        //Get upload file's metadata\n        $info = $this->fileUtil->getPathInfo($uploadedFileData['name']);\n        //Validate extension is allowed\n        if (!in_array($info['extension'], $this->allowedExt, true)) {\n            throw new ValidationException('Only JPEG files allowed');\n        }\n\n        //Initiate WriteInterface instance of the target directory\n        //Target dir is a sub-dir of PUB\n        $uploadDir = $this->writeFactory->create(\n            $this->filesystem->getDirectoryRead(\\Magento\\Framework\\App\\Filesystem\\DirectoryList::PUB)\n                ->getAbsolutePath(self::UPLOAD_DIR)\n        );\n        //Get target path if uploaded to the dir\n        $realPath  =$uploadDir->getDriver()->getRealPathSafety($uploadDir->getAbsolutePath($uploadedFileData['name']));\n\n        //Validate that the target file name is not a system file\n        $this->validateNotSystemFile($realPath);\n        //Validate that target folder (UPLOAD_DIR + ['name'] - ['basename']) is not a system folder\n        $this->validateNotSystemFolder(preg_replace('/\\/[^\\/]+$/', '', $realPath));\n        //Validate that given file doesn't exist or is own by current customer\n        $existingMediaFileInfo = $this->findFileByRelativePath($realPath);\n        if ($existingMediaFileInfo && $existingMediaFileInfo->getCustomerId() !== $customerId) {\n            throw new ValidationException('Access denied');\n        }\n\n        //Copy temp file to target path\n        $uploadDir->getDriver()->copy(\n            $uploadedFileData['tmp_name'],\n            $realPath\n        );\n\n        //Persist file info\n        $mediaFile = new MediaFile($customerId, $realPath);\n        return $this->persist($mediaFile);\n    }\n}\n")))}c.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-development-security-file-uploads-md-d0ae9747e99e08c92454.js.map