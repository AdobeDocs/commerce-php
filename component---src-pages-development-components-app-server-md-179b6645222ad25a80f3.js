"use strict";(self.webpackChunkcommerce_php=self.webpackChunkcommerce_php||[]).push([[7159],{64256:function(e,t,a){a.r(t),a.d(t,{_frontmatter:function(){return l},default:function(){return h}});var n=a(87462),i=a(45987),o=(a(35776),a(3905)),r=a(91515);const s=["components"],l={},d=(p="InlineAlert",function(e){return console.warn("Component "+p+" was not imported, exported, or provided by MDXProvider as global scope"),(0,o.mdx)("div",e)});var p;const m={_frontmatter:l},c=r.Z;function h(e){let{components:t}=e,a=(0,i.Z)(e,s);return(0,o.mdx)(c,(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,o.mdx)(d,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,o.mdx)("p",null,"Available in ",(0,o.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-operations/release/notes/adobe-commerce/2-4-7.html"},"2.4.7")," only."),(0,o.mdx)("h1",{id:"application-server-for-graphql-apis"},"Application Server for GraphQL APIs"),(0,o.mdx)("p",null,"The ",(0,o.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-operations/performance-best-practices/performance-best-practices/application-server.html"},"Application Server for GraphQL APIs")," enables Adobe Commerce to maintain state among GraphQL API requests. The Application Server, which is built on the Open Swoole extension, operates as a process with worker threads that handle request processing. By preserving a bootstrapped application state among GraphQL API requests, the Application Server enhances request handling and overall product performance. As a result, GraphQL request response time can be reduced by up to 30%."),(0,o.mdx)("p",null,"The Application Server is supported on ",(0,o.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/architecture/starter-architecture.html"},"Cloud Starter")," deployments only. It is not available for Cloud Pro projects during Beta. It is not available for deployments of the Magento Open Source code base."),(0,o.mdx)("h2",{id:"challenges-to-consider"},"Challenges to consider"),(0,o.mdx)("p",null,"Ensuring compatibility between your extension and the Application Server can be challenging without the right information."),(0,o.mdx)("p",null,"This page provides all the details that you need to make sure that your code is compatible with the Application Server, including recommendations and testing instructions. Key concepts include:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"Resource management"),(0,o.mdx)("li",{parentName:"ul"},"Memory and resource leaks"),(0,o.mdx)("li",{parentName:"ul"},"Cookies, sessions, and superglobals"),(0,o.mdx)("li",{parentName:"ul"},"Testing and debugging")),(0,o.mdx)("h3",{id:"resources-management"},"Resources Management"),(0,o.mdx)("p",null,"In environments using ",(0,o.mdx)("inlineCode",{parentName:"p"},"php-fpm"),", SQL connections, file handles, and other resources are automatically closed or reset at the conclusion of each HTTP request, ensuring that each new request starts with a clean slate. This mechanism helps prevent memory leaks and resource exhaustion, which can lead to degraded performance or application failure. The Application Server contains a cleanup process. This process is triggered after a response is dispatched, guaranteeing that all resources are properly released or reset, thereby maintaining the application's performance and reliability over time."),(0,o.mdx)("h3",{id:"memory-and-resource-leaks"},"Memory and resource leaks"),(0,o.mdx)("p",null,"Memory and resource management in PHP can often be overlooked due to the stateless nature of HTTP request handling, where resources are automatically released at the end of each request. However, in long-running scripts or applications, such as those using Swoole, proper management becomes crucial to prevent leaks and ensure efficient operation. Leaks occur when the application fails to release memory or resources that are no longer needed, leading to increased memory consumption and potential degradation of performance or even application failure over time."),(0,o.mdx)("h3",{id:"cookies-sessions-and-superglobals"},"Cookies, sessions, and superglobals"),(0,o.mdx)("p",null,"Using cookies, sessions, and superglobals can be a challenge due to Swoole's asynchronous, long-running server environment, which differs significantly from the traditional, stateless PHP-FPM model. Since Swoole keeps the PHP application in memory across requests, traditional PHP superglobals like ",(0,o.mdx)("inlineCode",{parentName:"p"},"$_GET"),", ",(0,o.mdx)("inlineCode",{parentName:"p"},"$_POST"),", and ",(0,o.mdx)("inlineCode",{parentName:"p"},"$_SESSION")," do not automatically reset between requests, potentially leading to data leakage or incorrect data being served to users."),(0,o.mdx)("p",null,"Additionally, implementing session management and cookie handling requires careful consideration to ensure thread safety and data isolation among concurrent requests, posing a significant challenge in preserving the state and security of a Swoole application."),(0,o.mdx)("h3",{id:"testing-and-debugging"},"Testing and debugging"),(0,o.mdx)("p",null,"Traditional debugging tools and techniques designed for synchronous PHP scripts may not work as expected, as they might not properly handle the concurrency and parallel execution of tasks within Swoole. Developers must adopt or develop tools that are capable of understanding and interacting with asynchronous operations, as well as establish testing environments that can simulate the concurrent execution of multiple requests. This requires a shift in approach to both debugging and testing, with an emphasis on asynchronous logic, co-routine lifecycle management, and the potential for shared-state issues, making the process more challenging than in traditional PHP environments."),(0,o.mdx)("h2",{id:"common-reasons-for-incompatibility"},"Common reasons for incompatibility"),(0,o.mdx)("ol",null,(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("a",{parentName:"li",href:"../../coding-standards/technical-guidelines.md"},"Not following technical guidelines"))),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("p",{parentName:"li"},"2.9. Service classes (ones that provide behavior but not data, like EventManager) SHOULD NOT have a mutable state. To make extensions codebase compliant with technical guidelines mutable states should be removed from Service classes. For example, a property cache introduced for better performance when dealing with data-intensive operations, such as database queries, API calls, or complex calculations, that does not need to be executed repeatedly within the same request. However, this can cause issues with the Application Server, since the property cache would be used in consequent requests and it should be reset after each request.")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("p",{parentName:"li"},"2.14. Temporal coupling MUST be avoided. Changed state at one point in time can inadvertently affect the behavior of subsequent operations, requiring a specific order of execution for the application to function correctly. This coupling makes the code harder to understand and maintain, as the correct operation of the system becomes dependent on the sequence in which state-modifying actions are performed."))),(0,o.mdx)("ol",null,(0,o.mdx)("li",{parentName:"ol"},"Usage of superglobals, like ",(0,o.mdx)("inlineCode",{parentName:"li"},"$_GET"),", ",(0,o.mdx)("inlineCode",{parentName:"li"},"$_POST"),", and ",(0,o.mdx)("inlineCode",{parentName:"li"},"$_SESSION"),", and native PHP functions for header, session, and cookie, instead of utilizing interfaces through dependency injection.")),(0,o.mdx)("h2",{id:"integration-testing"},"Integration testing"),(0,o.mdx)("p",null,"This section describes integration tests that you can use when developing your extension to ensure compatibility with the Application Server."),(0,o.mdx)("h3",{id:"graphqlstatetests"},"GraphQlStateTests"),(0,o.mdx)("p",null,"This test finds the state in shared objects that should not be reused for multiple requests. It currently runs against 67 different GraphQL requests, which could be extended."),(0,o.mdx)("p",null,"GraphQlStateTest is a test that looks for state changes in service objects created by ObjectManager. It does this by running a GraphQL query twice, and comparing the state of the service objects before and after the second query."),(0,o.mdx)("p",null,"There are two files used to filter and skip classes that are safe to be reused in a stateful application:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("inlineCode",{parentName:"li"},"dev/tests/integration/testsuite/Magento/GraphQl/_files/state-skip-list.php"),"—Skips the comparison of objects by their class name or virtual name (as defined in the ",(0,o.mdx)("inlineCode",{parentName:"li"},"di.xml")," file)."),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("inlineCode",{parentName:"li"},"dev/tests/integration/testsuite/Magento/GraphQl/_files/state-filter-list.php"),"—Filters out the properties that should be compared.")),(0,o.mdx)(d,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,o.mdx)("p",null,"There are similar files in the ",(0,o.mdx)("inlineCode",{parentName:"p"},"magento/magento2ee")," GitHub repository for classes that are specific to ",(0,o.mdx)("inlineCode",{parentName:"p"},"magento2ee"),". Similarly, other repositories can use their own files."),(0,o.mdx)("p",null,"In the ",(0,o.mdx)("inlineCode",{parentName:"p"},"state-filter-list.php")," file, there are three different types of filtering:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"The ",(0,o.mdx)("inlineCode",{parentName:"li"},"all")," section filters these property names from all of the service objects."),(0,o.mdx)("li",{parentName:"ul"},"The ",(0,o.mdx)("inlineCode",{parentName:"li"},"parents")," section first compares the service object to the specified class or interface using the ",(0,o.mdx)("inlineCode",{parentName:"li"},"instanceof")," operator. If it returns true, then those filters are applied."),(0,o.mdx)("li",{parentName:"ul"},"The ",(0,o.mdx)("inlineCode",{parentName:"li"},"services")," section checks for direct matches of the ",(0,o.mdx)("inlineCode",{parentName:"li"},"serviceName"),". The ",(0,o.mdx)("inlineCode",{parentName:"li"},"serviceName")," can either be the class name, or virtual type of preferences (as defined in ",(0,o.mdx)("inlineCode",{parentName:"li"},"di.xml")," files) before applying the properties filter.")),(0,o.mdx)("p",null,"If you are working on a failure and it does not look like it is safe to add to the skip or filter list, then consider if you can refactor the class in a ",(0,o.mdx)("a",{parentName:"p",href:"https://developer.adobe.com/commerce/contributor/guides/code-contributions/backward-compatibility-policy/"},"backwards-compatible")," way to use Factories of the service classes that have mutable state. If it is the class itself that has mutable state, then try to rewrite it in a way to avoid mutable state. If the mutable state is required for performance reasons, then implement ",(0,o.mdx)("inlineCode",{parentName:"p"},"ResetAfterRequestInterface")," and use ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()")," to reset the object back to its initial constructed state."),(0,o.mdx)("p",null,"If the class is failing because of a ",(0,o.mdx)("inlineCode",{parentName:"p"},"Typed property $x must not be accessed before initialization")," error, then the property is not initialized by the constructor. This is a form of temporal coupling, because the object cannot be used after it is initially constructed. This happens even if the property is private because the Collector gets the data from the properties using PHP's reflection feature. In this case, refactor the class to avoid temporal coupling, and also to avoid mutable state. If that does not work, the property can change its type to a nullable type and be initialized to null. If the property is an array, it may be okay to initialize the property as an empty array."),(0,o.mdx)("p",null,"Command to run test:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-bash"},"vendor/bin/phpunit -c $(pwd)/dev/tests/integration/phpunit.xml dev/tests/integration/testsuite/Magento/GraphQl/App/GraphQlStateTest.php\n")),(0,o.mdx)("h3",{id:"resetafterrequesttest"},"ResetAfterRequestTest"),(0,o.mdx)("p",null,(0,o.mdx)("inlineCode",{parentName:"p"},"ResetAfterRequestTest")," finds all classes that implement ",(0,o.mdx)("inlineCode",{parentName:"p"},"ResetAfterRequestInterface")," and verifies that the ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()")," method returns the state of the object to the same state as it was after being constructed by ObjectManager. It does this by creating a service object with ObjectManager, cloning that object, then calling ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()")," and comparing it. It does not call any methods in between object instantiation and ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()"),", so it does not confirm resetting any mutable state. If it finds bugs or typos in ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()"),", it may set the state to something different than the original state."),(0,o.mdx)("p",null,"If this test fails, then you should check to see if you have changed a class in a way where the object has different values in properties after construction comparted to after the ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()")," method is called. If the class that you are working on does not have the ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()")," method itself, then check the class hierarchy for a superclass that is implementing it."),(0,o.mdx)("p",null,"If the class is failing because of a ",(0,o.mdx)("inlineCode",{parentName:"p"},"Typed property $x must not be accessed before initialization")," error, see the discussion about this problem in the ",(0,o.mdx)("a",{parentName:"p",href:"#graphqlstatetests"},"GraphQlStateTest")," section."),(0,o.mdx)("p",null,"Command to run test:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-bash"},"vendor/bin/phpunit -c $(pwd)/dev/tests/integration/phpunit.xml dev/tests/integration/testsuite/Magento/Framework/ObjectManager/ResetAfterRequestTest.php\n")),(0,o.mdx)("h2",{id:"how-to-fix-test-failures"},"How to fix test failures"),(0,o.mdx)("p",null,"To set up local testing and debugging:"),(0,o.mdx)("ol",null,(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Install the Swoole extension:"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre",className:"language-bash"},"pecl install swoole\n"))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Route all GraphQL requests to the application server (nginx example):"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre",className:"language-php"},"location /graphql {\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n    proxy_pass http://127.0.0.1:9501/graphql;\n}\n"))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Run the application server with the CLI command:"),(0,o.mdx)("pre",{parentName:"li"},(0,o.mdx)("code",{parentName:"pre",className:"language-bash"},"bin/magento server:run\n"))),(0,o.mdx)("li",{parentName:"ol"},(0,o.mdx)("p",{parentName:"li"},"Execute GraphQL mutations against the application server and debug with xDebug if needed."))),(0,o.mdx)("h2",{id:"example-of-mutable-state-in-code"},"Example of mutable state in code"),(0,o.mdx)("p",null,"Example with the ",(0,o.mdx)("inlineCode",{parentName:"p"},"Magento\\Catalog\\Model\\Product\\Image\\Cache")," class:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-php"},"/**\n  * @var array\n  */\n protected $data = [];\n")),(0,o.mdx)("p",null,"Review the following example to see how the ",(0,o.mdx)("inlineCode",{parentName:"p"},"$data")," property is used:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-php"},"   protected function getData()\n   {\n       if (!$this->data) {\n           foreach ($this->themeCollection->loadRegisteredThemes() as $theme) {\n               $config = $this->viewConfig->getViewConfig([\n                   'area' => Area::AREA_FRONTEND,\n                   'themeModel' => $theme,\n               ]);\n               $images = $config->getMediaEntities('Magento_Catalog', ImageHelper::MEDIA_TYPE_CONFIG_NODE);\n               foreach ($images as $imageId => $imageData) {\n                   $this->data[$theme->getCode() . $imageId] = array_merge(['id' => $imageId], $imageData);\n               }\n           }\n       }\n       return $this->data;\n   }\n")),(0,o.mdx)("h3",{id:"how-to-fix-mutable-state"},"How to fix mutable state"),(0,o.mdx)("p",null,"There are several challenges you may face for refactoring the code with mutable state, including, but not limited to:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"Backwards compatibility"),(0,o.mdx)("li",{parentName:"ul"},"Performance efficiency"),(0,o.mdx)("li",{parentName:"ul"},"Lack of time")),(0,o.mdx)("p",null,"In the example with the ",(0,o.mdx)("a",{parentName:"p",href:"#example-of-mutable-state-in-code"},(0,o.mdx)("inlineCode",{parentName:"a"},"Magento\\Catalog\\Model\\Product\\Image\\Cache"))," class, we can see performance benefits of reusing the ",(0,o.mdx)("inlineCode",{parentName:"p"},"$data")," property in the context of a single request, but we should reset the state after the request."),(0,o.mdx)("p",null,"For this purpose, we should implement the following:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-php"},"class Cache implements ResetAfterRequestInterface\n")),(0,o.mdx)("p",null,"Add the implementation of the ",(0,o.mdx)("inlineCode",{parentName:"p"},"_resetState()")," method with overriding ",(0,o.mdx)("inlineCode",{parentName:"p"},"$data")," property to its initial state - empty array:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-php"},"/**\n * @inheritDoc\n */\npublic function _resetState(): void\n{\n    $this->data = [];\n}\n")))}h.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-development-components-app-server-md-179b6645222ad25a80f3.js.map